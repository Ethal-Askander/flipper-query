<!DOCTYPE html>
<link rel="stylesheet" href="index.css">
<html lang="en">
<body>
<head>
    <title>Flipper Query</title>
    <link rel="shortcut icon" type="images/x-icon" href="icon.png" />
</head>

<div>
    <h1 class="title">Flipper Query</h1>
</div>

<div class="inputs-row">
    <form class="inputs-row" action="/search" method="GET">
        <input id="search" class="search-bar" type="text" name="q" placeholder="Jordan 1..." />

        <div class="input-group">
            <span>Shipping</span>
            <input id="shipping-cost" class="input-value" type="number" name="s" placeholder="30" min="0" max="1000" step="0.01"/>
        </div>

        <div class="input-group">
            <span>Commission</span>
            <input id="commission" class="input-value" type="number" name="c" placeholder="0.12" min="0" max="1" step="0.01"/>
        </div>

        <input id="submit-button" class="submit-button" type="submit" value="Search"/>
    </form>
</div>

<div id="container" class="card-container" />

<script>
    // Get search parameters
    const urlParams = new URLSearchParams(window.location.search);
    const query = urlParams.get('q') || "";
    const shipping = urlParams.get('s') ? parseFloat(urlParams.get('s')) : 30;
    const commission = urlParams.get('c') ? parseFloat(urlParams.get('c')) : 0.12;

    // Setup values
    document.getElementById('search').value = urlParams.get('q') ? query : "";
    document.getElementById('shipping-cost').value = urlParams.get('s') ? shipping : "";
    document.getElementById('commission').value = urlParams.get('c') ? commission : "";

    /**
     * @param url: URL to open.
     * Opens the given url.
     */
     const openWindow = (url) => {
        window.open(url);
    }

    /**
     * @param details: product details used to display information.
     * Creates a html product card to display.
     */
    const createCard = (details) => {
        //Calculating values
        const cost = Math.round((
            (details.retailPrice || 0) + 
            (shipping || 0) + 
            (details.highestBid ? details.highestBid*commission : 0) + 
            Number.EPSILON) * 100)
            / 100; // Rounds to 2dp with 5 going up.
        const profit = Math.round(((details.highestBid || 0) - cost + Number.EPSILON) * 100) / 100;
        // const profitPercentage = Math.floor((profit / details.retailPrice)*100);

        //Changing variant depending on profitability
        const Cardvariant = (profit > 0 ? 'pos' : 'neg');
        // const progressVariant = (profit > 0 ? 'success' : 'dark');

        return (
            `
            <div class="card ${profit > 0 ? "pos" : "neg"}">
                <img
                    width="80%"
                    height="50%"
                    src="${details.thumbnail_url}"
                />
                <p>Retail cost: ${details.retailPrice || "Not provided"} <br />
                Highest current bid: ${details.highestBid || "Not provided"} <br />
                Estimated costs: ${cost} <br />
                Estimated returns: ${profit} <br />
                </p>
            <a href="${details.url}">Go to</a>
            </div>
            `
        )
    }

    // Attempt to get response headers
    var req = new XMLHttpRequest();
    req.open('GET', document.location, false);
    req.send(null);
    
    // Get the products from search
    let products = req.getResponseHeader('products');
    if (products) {
        // Testing, to see how to parse and get information from a product.
        products = JSON.parse(products);
        for (product of products) {
            console.log(product);
        }
        document.getElementById('container').innerHTML = products.map(product => {
            return createCard(product);
        });
    }
</script>

<!-- <div class="card">
    <b>Jordan 1 Retro High Dark Mocha</b>
    <img 
        width="80%"
        height="50%"    
        src="https://stockx.imgix.net/images/Air-Jordan-1-Retro-High-Dark-Mocha-2-Product.jpg?fit=fill&bg=FFFFFF&w=300&h=214&auto=format,compress&trim=color&q=90&dpr=2&updated_at=1608736454"
    />
    <p>Retail cost: $350 <br />
    Estimated sale price: $700 <br />
    Estimated total additional costs: $210 <br />
    Profit: $140 <br />
    </p>

    <button>Go to</button>
    
</div> -->

</body>
</html>